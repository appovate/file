name: Update File Utility (Release)

on:
  schedule:
    - cron: "0 0 * * 0"   # every Sunday
  workflow_dispatch:

jobs:
  release-file:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install required tools
        run: |
          sudo apt-get update
          sudo apt-get install -y wget dpkg-dev rsync zip

      - name: Detect latest File version using Termux Packages index
        id: get_version
        run: |
          # Base URL for aarch64 Packages index
          BASE_INDEX="https://grimler.se/termux-main/dists/stable/main/binary-aarch64/Packages"

          # Extract latest filename for package "file"
          LATEST_FILE=$(wget -qO- "$BASE_INDEX" \
            | awk '/^Package: file$/ {pkg=1; next} pkg && /^Filename:/ {print $2; pkg=0}' \
            | sort -V \
            | tail -n1)

          if [[ -z "$LATEST_FILE" ]]; then
            echo "Error: Could not find latest file package!"
            exit 1
          fi

          # Extract version from filename
          VERSION=$(basename "$LATEST_FILE" | sed -E 's/file_([^_]*)_.*/\1/')

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "file=$LATEST_FILE" >> $GITHUB_OUTPUT
          echo "Latest file package: $LATEST_FILE"
          echo "Version: $VERSION"

      - name: Download, normalize paths, and zip per-ABI
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"

          declare -A archs=(
            [aarch64]=aarch64
            [arm]=arm
            [i686]=i686
            [x86_64]=x86_64
          )

          rm -rf dist work
          mkdir -p dist work

          for arch in "${!archs[@]}"; do
            BASE_INDEX="https://grimler.se/termux-main/dists/stable/main/binary-${arch}/Packages"

            # Get the exact filename for this architecture
            DEB_PATH=$(wget -qO- "$BASE_INDEX" \
              | awk '/^Package: file$/ {pkg=1; next} pkg && /^Filename:/ {print $2; pkg=0}' \
              | grep "_${arch}\.deb$" \
              | sort -V \
              | tail -n1)

            if [[ -z "$DEB_PATH" ]]; then
              echo "Warning: Could not find file package for $arch, skipping..."
              continue
            fi

            FILE_NAME=$(basename "$DEB_PATH")
            URL="https://grimler.se/termux-main/$DEB_PATH"

            echo "Downloading $FILE_NAME from $URL"
            wget -q "$URL" -O "$FILE_NAME"

            # Extract deb
            mkdir -p "work/$arch"
            dpkg-deb -x "$FILE_NAME" "work/$arch"

            # Normalize layout: copy usr/ only
            mkdir -p "dist/file-$arch/usr"
            rsync -a "work/$arch/data/data/com.termux/files/usr/" \
                     "dist/file-$arch/usr/"

            # Zip per architecture
            cd dist
            zip -qr "file-${VERSION}-${arch}.zip" "file-$arch"
            cd ..
          done

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: file-${{ steps.get_version.outputs.version }}
          name: File Utility ${{ steps.get_version.outputs.version }}
          body: |
            File utility binaries built from Termux packages.

            Path normalization applied:
            - Removed /data/data/com.termux/files
            - Root starts at /usr

            Included architectures:
            - aarch64
            - arm
            - i686
            - x86_64
          files: dist/*.zip
